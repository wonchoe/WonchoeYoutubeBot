#!/bin/bash
set -e

# –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä–∏–π cookies —Ñ–∞–π–ª —è–∫—â–æ —ñ—Å–Ω—É—î (–º–æ–∂–µ –±—É—Ç–∏ –∑–∞–ª–∏—à–æ–∫ –≤—ñ–¥ volume mount)
if [ -f "/tmp/cookies.txt" ]; then
    echo "üóëÔ∏è  Removing old /tmp/cookies.txt..."
    rm -f /tmp/cookies.txt
fi

# –ö–æ–ø—ñ—é—î–º–æ read-only cookies –≤ /tmp/ —è–∫—â–æ –≤–æ–Ω–∏ —ñ—Å–Ω—É—é—Ç—å
if [ -f "/app/cookies.txt" ]; then
    echo "üìã Copying and fixing cookies from /app/cookies.txt to /tmp/cookies.txt..."
    
    # –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ cookies –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π Netscape —Ñ–æ—Ä–º–∞—Ç
    python3 - <<'EOF'
import re
import sys

def fix_cookies(input_file, output_file):
    """–ö–æ–Ω–≤–µ—Ä—Ç—É—î cookies –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π Netscape —Ñ–æ—Ä–º–∞—Ç"""
    
    with open(input_file, 'r') as f:
        content = f.read()
    
    fixed_lines = []
    fixed_lines.append("# Netscape HTTP Cookie File\n")
    fixed_lines.append("# This file was generated by entrypoint.sh\n")
    
    for line in content.split('\n'):
        line = line.strip()
        
        # Skip empty lines and comments
        if not line or line.startswith('#'):
            continue
        
        # –†–æ–∑–±–∏–≤–∞—î–º–æ –ø–æ —Ç–∞–±—É–ª—è—Ü—ñ—ó –∞–±–æ –º–Ω–æ–∂–∏–Ω–Ω–∏—Ö –ø—Ä–æ–±—ñ–ª–∞—Ö
        parts = re.split(r'\t+|\s{2,}', line)
        
        if len(parts) >= 7:
            domain = parts[0]
            flag = parts[1] if parts[1] in ['TRUE', 'FALSE'] else 'TRUE'
            path = parts[2]
            secure = parts[3] if parts[3] in ['TRUE', 'FALSE'] else 'FALSE'
            expiration = parts[4]
            name = parts[5]
            # Value –º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ –ø—Ä–æ–±—ñ–ª–∏, —Ç–æ–º—É –±–µ—Ä–µ–º–æ –≤—Å–µ —â–æ –∑–∞–ª–∏—à–∏–ª–æ—Å—å
            value = '\t'.join(parts[6:]) if len(parts) > 7 else parts[6]
            
            # –í–∏–¥–∞–ª—è—î–º–æ \n –∑ –∫—ñ–Ω—Ü—è value —è–∫—â–æ —î
            value = value.rstrip('\n')
            
            # –§–æ—Ä–º—É—î–º–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ä—è–¥–æ–∫
            fixed_line = f"{domain}\t{flag}\t{path}\t{secure}\t{expiration}\t{name}\t{value}\n"
            fixed_lines.append(fixed_line)
    
    with open(output_file, 'w') as f:
        f.writelines(fixed_lines)
    
    print(f"‚úÖ Fixed {len(fixed_lines) - 2} cookies")

fix_cookies('/app/cookies.txt', '/tmp/cookies.txt')
EOF
    
    chmod 644 /tmp/cookies.txt
    echo "‚úÖ Cookies fixed and copied successfully"
else
    echo "‚ö†Ô∏è  Warning: /app/cookies.txt not found, bot will work without cookies"
    echo "   Some platforms may have limitations without authentication"
fi

# –ó–∞–ø—É—Å–∫–∞—î–º–æ –æ—Å–Ω–æ–≤–Ω–∏–π –ø—Ä–æ—Ü–µ—Å
echo "üöÄ Starting YouTube Downloader Bot..."
exec python app.py
